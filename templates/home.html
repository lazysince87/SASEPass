{% extends "base.html" %}
{% block title %}SASEPass - Dashboard{% endblock %}

{% block body %}
<div class="min-h-screen flex flex-col">
    <!-- Top Bar -->
    <header class="sticky top-0 z-50 bg-gray-900/80 backdrop-blur-lg border-b border-gray-800">
        <div class="max-w-4xl mx-auto flex items-center justify-between px-4 py-3">
            <h1 class="text-xl font-bold text-white tracking-tight">SASEPass</h1>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-400">{{ session.get('user_name', 'Staff') }}</span>
                <a href="{{ url_for('logout') }}"
                    class="text-sm text-red-400 hover:text-red-300 font-medium transition">Sign Out</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 max-w-4xl mx-auto w-full px-4 py-8">
        <h2 class="text-2xl font-bold text-white mb-6">Select Event Scanner</h2>

        <!-- Search -->
        <div class="mb-6 flex gap-4">
            <form method="GET" action="{{ url_for('home') }}" class="flex-1 flex gap-2">
                <input id="event-search" type="text" name="q" value="{{ search_query }}" placeholder="Search events..."
                    class="w-full px-4 py-2.5 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition" />
                {% if search_query %}
                <a href="{{ url_for('home') }}"
                    class="px-4 py-2.5 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition flex items-center gap-2 whitespace-nowrap">
                    Clear Search
                </a>
                {% endif %}
            </form>
            {% if session.get('is_admin') %}
            <!-- Admin Create Event -->
            <div class="relative flex" x-data="{ open: false }">
                <button onclick="document.getElementById('add-event-modal').classList.remove('hidden')"
                    class="px-4 py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-semibold transition flex items-center gap-2 whitespace-nowrap">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    New Event
                </button>
            </div>
            {% endif %}
        </div>


        <!-- Event Grid -->
        {% if events %}
        <div class="grid gap-3 sm:grid-cols-2">
            {% for event in events %}
            <div
                class="relative group block rounded-xl bg-gray-900 border border-gray-800 hover:border-brand-500/60 hover:bg-gray-900/80 transition-all duration-200">
                <a href="{{ url_for('event_detail', event_name=event) }}" class="p-5 flex items-center justify-between">
                    <span class="text-base font-semibold text-gray-100 group-hover:text-brand-300 transition">{{ event
                        }}</span>
                    <svg class="w-5 h-5 text-gray-600 group-hover:text-brand-400 transition" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
                {% if session.get('is_admin') and event != 'Check-in' %}
                <button onclick="promptDeleteEvent('{{ event }}')"
                    class="absolute top-1/2 -translate-y-1/2 right-12 p-1.5 text-red-400 hover:text-red-300 bg-gray-900 border border-red-900/50 rounded-md opacity-0 group-hover:opacity-100 transition pointer-events-auto shadow-lg z-10"
                    title="Delete event">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-16 text-gray-500">
            <p class="text-lg">No events found.</p>
        </div>
        {% endif %}
        <!-- Admin Modal -->
        {% if session.get('is_admin') %}
        <div id="add-event-modal"
            class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/60 backdrop-blur-sm px-4">
            <div class="bg-gray-900 border border-gray-800 rounded-xl max-w-sm w-full p-6 relative">
                <button onclick="document.getElementById('add-event-modal').classList.add('hidden')"
                    class="absolute top-4 right-4 text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <h3 class="text-xl font-bold text-white mb-4">Create New Event</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Event Name</label>
                        <input id="new-event-name" type="text" placeholder="e.g. Midnight Snack"
                            class="w-full px-4 py-2.5 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-brand-500 transition" />
                    </div>
                    <button id="submit-new-event"
                        class="w-full py-2.5 rounded-lg bg-brand-600 hover:bg-brand-500 text-white font-semibold transition active:scale-[0.98]">
                        Create Event
                    </button>
                    <div id="new-event-result" class="hidden px-4 py-3 rounded-lg text-sm font-medium mt-3"></div>
                </div>
            </div>
        </div>

        <script>
            document.getElementById('submit-new-event')?.addEventListener('click', async () => {
                const btn = document.getElementById('submit-new-event');
                const resultDiv = document.getElementById('new-event-result');
                const eventName = document.getElementById('new-event-name').value.trim();

                if (!eventName) {
                    resultDiv.className = 'px-4 py-3 rounded-lg text-sm font-medium mt-3 bg-red-900/50 text-red-400 border border-red-800';
                    resultDiv.textContent = 'Event name is required';
                    resultDiv.classList.remove('hidden');
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Creating...';
                resultDiv.classList.add('hidden');

                try {
                    const res = await fetch('/api/create_event', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event_name: eventName })
                    });
                    const data = await res.json();

                    if (data.status === 'success') {
                        resultDiv.className = 'px-4 py-3 rounded-lg text-sm font-medium mt-3 bg-emerald-900/50 text-emerald-400 border border-emerald-800';
                        resultDiv.textContent = data.message;
                        resultDiv.classList.remove('hidden');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        throw new Error(data.message);
                    }
                } catch (e) {
                    resultDiv.className = 'px-4 py-3 rounded-lg text-sm font-medium mt-3 bg-red-900/50 text-red-400 border border-red-800';
                    resultDiv.textContent = e.message || 'Server error';
                    resultDiv.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = 'Create Event';
                }
            });

            async function promptDeleteEvent(eventName) {
                const password = prompt(`Enter the delete password to proceed deleting "${eventName}":`);
                if (!password) return;
                try {
                    const res = await fetch('/api/delete_event', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event_name: eventName, password: password })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert("Error: " + data.message);
                    }
                } catch (e) {
                    alert("Server error.");
                }
            }
        </script>
        {% endif %}

    </main>
</div>
{% endblock %}